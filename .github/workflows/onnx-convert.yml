name: ONNX Conversion

on:
  workflow_dispatch:
  push:
    paths:
      - 'scripts/convert_to_onnx.py'
      - 'models/tflite/**'
      - '.github/workflows/onnx-convert.yml'

permissions:
  contents: write

jobs:
  convert:
    runs-on: ubuntu-22.04
    timeout-minutes: 25
    env:
      GRADLE_OPTS: "-Djava.net.preferIPv4Stack=true -Djava.net.preferIPv6Addresses=false -Dfile.encoding=UTF-8"
      MOVEMENT_ANALYSIS_MODEL_URL: ${{ secrets.MOVEMENT_ANALYSIS_MODEL_URL }}
      MOVEMENT_ANALYSIS_MODEL_SHA256: ${{ secrets.MOVEMENT_ANALYSIS_MODEL_SHA256 }}
      MOVENET_VARIANT: lightning
      MODEL_MOVENET_LIGHTNING_ONNX_SHA256: ${{ secrets.MODEL_MOVENET_LIGHTNING_ONNX_SHA256 }}

    steps:
      - name: Force IPv4 (disable IPv6)
        run: |
          echo 'precedence ::ffff:0:0/96  100' | sudo tee -a /etc/gai.conf
          sudo sysctl -w net.ipv6.conf.all.disable_ipv6=1
          sudo sysctl -w net.ipv6.conf.default.disable_ipv6=1
          sudo sysctl -w net.ipv6.conf.lo.disable_ipv6=1

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install conversion deps (TensorFlow + tf2onnx)
        run: |
          python -m pip install --upgrade pip
          pip install tensorflow==2.17.0 tf2onnx onnx tensorflow_hub

      - name: Fetch models (TFLite)
        run: bash scripts/fetch_models.sh

      - name: Verify base TFLite models
        run: ./gradlew :app:verifyModels --stacktrace

      - name: Convert to ONNX (SavedModel pipeline - MoveNet)
        run: |
          python scripts/export_savedmodel_and_convert.py
          ls -lh models/onnx

      - name: (Legacy) Attempt generic TFLiteâ†’ONNX conversion (best-effort)
        run: |
          python scripts/convert_to_onnx.py || echo "Legacy conversion script finished (non-fatal)"

      - name: Validate ONNX models
        run: |
          python -m pip install onnx
          python scripts/validate_onnx.py

      - name: Gradle ONNX verify & integrity
        run: |
          ./gradlew :app:verifyOnnxModels :app:generateModelIntegrity --stacktrace
          echo '--- INTEGRITY (head) ---'
          sed -n '1,60p' models/INTEGRITY.md

      - name: ONNX Runtime Smoke Test
        run: |
          python -m pip install onnxruntime
          python - <<'PY'
import os, onnxruntime as ort
root='models/onnx'
failed=0
for f in os.listdir(root):
  if not f.endswith('.onnx'): continue
  path=os.path.join(root,f)
  print('SmokeTest', f)
  try:
    sess=ort.InferenceSession(path, providers=['CPUExecutionProvider'])
    inputs={i.name: ( ( [ [ [0.0]* (d or 1) ] ] ) if len(i.shape)==4 else [0.0]*(i.shape[1] if len(i.shape)>1 and i.shape[1] else 1) ) for i in sess.get_inputs()}
    sess.run(None, inputs)
    print('  OK')
  except Exception as e:
    print('  FAIL', e)
    failed+=1
if failed:
  raise SystemExit(f"{failed} ONNX smoke test(s) failed")
PY

      - name: List ONNX outputs
        run: ls -lh models/onnx

      - name: Commit & push ONNX models
        if: success()
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add models/INTEGRITY.md || true
          if [ -n "$(git status --porcelain models/onnx models/INTEGRITY.md)" ]; then
            git add models/onnx
            git commit -m "chore(onnx): update ONNX models & integrity report"
            git push
          else
            echo "No ONNX changes to commit"
          fi

      - name: Upload ONNX artifacts
        uses: actions/upload-artifact@v4
        with:
          name: onnx-models
          path: models/onnx/*.onnx
          if-no-files-found: warn
          retention-days: 7
